angular.module("angularCacheServiceModule",[]).factory("cacheService",["$window","$q","$timeout",function(a,b,c){var d={};d.name="POLY_FILL",d.dbName="cacheDB",d.entityName="cacheTable",d.options={},d.open=function(){var a=b.defer();return d.dbName=d.options.dbName,d.entityName=d.options.entityName,c(function(){a.resolve(d)}),a.promise},d.save=d.setItem=function(a,e){var f=b.defer(),g=!1;return a?(d[a]=e,g=!0,c(function(){d.removeItem(a)},d.options.maxAge)):console.warn("key should be a valid truthy"),c(function(){f.resolve(g)}),f.promise},d.get=d.getItem=function(a){var e=b.defer(),f=d[a];return c(f?function(){e.resolve(f)}:function(){e.resolve(null)}),e.promise},d.remove=d.removeItem=function(a){var e=b.defer();return d.hasOwnProperty(a)?(delete d[a],c(function(){e.resolve()})):e.reject(),e.promise},d.length=function(){var a,e=b.defer(),f=0;for(a in d)d.hasOwnProperty(a)&&"name"!==a&&"dbName"!==a&&"entityName"!==a&&"options"!==a&&"open"!==a&&"save"!==a&&"setItem"!==a&&"get"!==a&&"getItem"!==a&&"remove"!==a&&"removeItem"!==a&&"length"!==a&&"clear"!==a&&f++;return c(function(){e.resolve(f)}),e.promise},d.clear=function(){var a,e=b.defer();try{for(a in d)d.hasOwnProperty(a)&&"name"!==a&&"dbName"!==a&&"entityName"!==a&&"options"!==a&&"open"!==a&&"save"!==a&&"setItem"!==a&&"get"!==a&&"getItem"!==a&&"remove"!==a&&"removeItem"!==a&&"length"!==a&&"clear"!==a&&delete d[a];console.log("POLY_FILL data cleared"),c(function(){e.resolve()})}catch(f){c(function(){e.reject()})}return e.promise};var e=function(a){var b=!1;if(a)if(a.code)switch(a.code){case 22:b=!0;break;case 1014:"NS_ERROR_DOM_QUOTA_REACHED"===a.name&&(b=!0)}else-2147024882===a.number&&(b=!0);return b},f=function(a,b,d){var e;try{a.db.setItem(b,d)}catch(f){if(a.storeQuotaExceeded(f)){var g=0;for(var h in a.db)if(a.db.getItem(h)){if(g===a.options.deletableCacheItems)break;e&&c.cancel(e),a.removeItem(h).then(i)}var i=function(){g++}}try{a.db.setItem(b,d)}catch(j){return console.error("error persisting data: "+j),!1}}return e=c(function(){a.removeItem(b)},a.options.maxAge),!0},g={};g.name="localStorage",g.dbName="cacheDB",g.entityName="cacheTable",g.db=a.localStorage,g.storeQuotaExceeded=e,g.options={},g.open=function(){var a=b.defer();return g.dbName=g.options.dbName,g.entityName=g.options.entityName,c(function(){a.resolve(g.db)}),a.promise},g.save=g.setItem=function(a,c){var d=b.defer();if(a){var e=f(g,a,c);d.resolve(e)}else d.reject();return d.promise},g.get=g.getItem=function(a){var c=b.defer();return data=g.db.getItem(a),c.resolve(data),c.promise},g.remove=g.removeItem=function(a){var c=b.defer();return g.db.removeItem(a),c.resolve(),c.promise},g.length=function(){var a=b.defer(),c=0;return c=g.db.length,a.resolve(c),a.promise},g.clear=function(){var a=b.defer();return g.db.clear(),a.resolve(),console.log("localStorageDB data cleared"),a.promise};var h={};h.name="sessionStorage",h.dbName="cacheDB",h.entityName="cacheTable",h.db=a.sessionStorage,h.storeQuotaExceeded=e,h.options={},h.open=function(){var a=b.defer();return h.dbName=h.options.dbName,h.entityName=h.options.entityName,c(function(){a.resolve(h.db)}),a.promise},h.save=h.setItem=function(a,c){var d=b.defer();if(a){var e=f(h,a,c);d.resolve(e)}else d.reject();return d.promise},h.get=h.getItem=function(a){var c=b.defer();return data=h.db.getItem(a),c.resolve(data),c.promise},h.remove=h.removeItem=function(a){var c=b.defer();return h.db.removeItem(a),c.resolve(),console.log("localSessionStorage data cleared"),c.promise},h.length=function(){var a=b.defer(),c=0;return c=h.db.length,a.resolve(c),a.promise},h.clear=function(){var a=b.defer();return h.db.clear(),a.resolve(),a.promise};var i={};i.version=1,i.name="indexedDB",i.dbName="cacheDB",i.entityName="cacheTable",i.options={},i.open=function(){var d=b.defer();if(i.dbName=i.options.dbName,i.entityName=i.options.entityName,i.db)return c(function(){d.resolve(i.db)}),d.promise;if(!(a.indexedDB=a.IndexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB)){var e="indexedDB not supported on this device";return console.warn(e),c(function(){d.resolve(null)}),d.promise}"webkitIndexedDB"in a&&(a.IDBTransaction=a.IDBTransaction||a.webkitIDBTransaction||a.msIDBTransaction,a.IDBKeyRange=a.IDBKeyRange||a.webkitIDBKeyRange||a.msIDBKeyRange);var f=a.indexedDB.open(i.dbName,i.version);return f.onupgradeneeded=function(b){var c=b.target.result;i.db=c,b.target.transaction.onerror=a.indexedDB.onerror,c.objectStoreNames.contains(i.entityName)&&c.deleteObjectStore(i.entityName),c.createObjectStore(i.entityName),console.log(i.dbName+" indexedDB database created with store: "+i.entityName)},f.onsuccess=function(a){i.db=a.target.result,c(function(){d.resolve(i.db)})},f.onerror=function(a){var b="device might be operating incognito. localIndexedDB couldn't be created/opened. error: "+a.message;console.warn(b),c(function(){d.resolve(null)})},d.promise},i.save=i.setItem=function(d,e){var f=b.defer();if(!d)return f.reject("invalid key"),f.promise;var g=i.db;if(!g){var h="localIndexedDB is not available";return console.warn(h),c(function(){f.reject(h)}),f.promise}var j=g.transaction([i.entityName],"readwrite"),k=j.objectStore(i.entityName),l=k.put(e,d),m=!1;return l.onsuccess=function(a){a.target.result&&(m=!0,c(function(){i.removeItem(d)},i.options.maxAge)),c(function(){f.resolve(m)})},l.onerror=function(b){var d=e+" couldn't be saved. error: "+b.message;console.warn(d);var g=function(a,b){console.log("used quota: "+a+", remaining quota: "+b)},h=function(a){console.log("error requesting storage space: "+a.message)};a.navigator.webkitTemporaryStorage?a.navigator.queryUsageAndQuota(g,h):a.webkitStorageInfo.queryUsageAndQuota(a.webkitStorageInfo.TEMPORARY,g,h),c(function(){f.resolve(m)})},f.promise},i.get=i.getItem=function(a){var d=b.defer(),e=i.db;if(!e){var f="localIndexedDB is not available";return console.warn(f),c(function(){d.reject(f)}),d.promise}var g=e.transaction([i.entityName],"readonly"),h=g.objectStore(i.entityName),j=h.get(a),k=null;return j.onsuccess=function(a){a.target.result&&(k=a.target.result),c(function(){d.resolve(k)})},j.onerror=function(b){var e="couldn't retrieved value for key: "+a+". error: "+b.message;console.warn(e),c(function(){d.resolve(k)})},d.promise},i.remove=i.removeItem=function(a){var d=b.defer(),e=i.db;if(!e){var f="localIndexedDB is not available";return console.warn(f),c(function(){d.reject(f)}),d.promise}var g=e.transaction([i.entityName],"readwrite"),h=g.objectStore(i.entityName),j=h["delete"](a);return j.onsuccess=function(){c(function(){d.resolve()})},j.onerror=function(b){var e="couldn't remove value for key: "+a+". error: "+b.message;console.warn(e),c(function(){d.reject(e)})},d.promise},i.clear=function(){var a=b.defer(),d=i.db;if(!d){var e="localIndexedDB is not available";return console.warn(e),c(function(){a.reject(e)}),a.promise}var f=d.transaction([i.entityName],"readwrite"),g=f.objectStore(i.entityName),h=g.clear();return h.onsuccess=function(){console.log(i.dbName+" indexedDB data cleared"),c(function(){a.resolve()})},h.onerror=function(b){var d="couldn't clear content of indexedDB: "+i.dbName+". error: "+b.message;console.warn(d),c(function(){a.reject(d)})},h.onblocked=function(b){var d="couldn't clear content of indexedDB: "+i.dbName+" due to operation being blocked. error: "+b.message;console.warn(d),c(function(){a.reject(d)})},a.promise},i.length=function(){var a=b.defer(),d=i.db;if(!d){var e="localIndexedDB is not available";console.warn(e),c(function(){a.reject(e)})}var f=d.transaction([i.entityName],"readwrite"),g=f.objectStore(i.entityName),h=g.count();return h.onsuccess=function(){c(function(){a.resolve(h.result)})},h.onerror=function(b){var d="couldn't clear compute size of indexedDB: "+i.dbName+". error: "+b.message;console.warn(d),c(function(){a.reject(d)})},a.promise};var j={};j.version="1.0",j.name="webSQL",j.dbName="cacheDB",j.entityName="cacheTable",j.dbDescription=j.dbName,j.dbSize=5242880,j.entitySize=0,j.options={},j.open=function(){var d=b.defer();j.dbName=j.options.dbName,j.entityName=j.options.entityName;try{if(j.db)return c(function(){d.resolve()}),d.promise;if(!a.openDatabase){var e="webSQL not supported on this device";return console.warn(e),c(function(){d.resolve(null)}),d.promise}j.db=a.openDatabase(j.dbName,j.version,j.dbDescription,j.dbSize),j.db.transaction(function(a){var b="CREATE TABLE IF NOT EXISTS "+j.entityName+" (cacheKey TEXT PRIMARY KEY, cacheValue TEXT)";a.executeSql(b,[],f,g)});var f=function(){c(function(){d.resolve(j.db)})},g=function(a,b){var e="";switch(b.code){case b.SYNTAX_ERR:e="syntax error has occurred. "+b.message,console.warn(e);break;default:e="error creating webSQL table "+j.entityName+". error: "+b}console.warn(e),c(function(){d.resolve(null)})}}catch(h){var e="error creating webSQL database/table. error: "+h;console.warn(e),c(function(){d.resolve(null)})}return d.promise},j.save=j.setItem=function(a,d){var e=b.defer(),f="";if(a||(f="invalid key",console.warn(f),c(function(){e.reject(f)})),!j.db)return f="localWebSQL.db undefined",console.warn(f),c(function(){e.reject(f)}),e.promise;var g=j.db,h=!1;g.transaction(function(b){var c="INSERT INTO "+j.entityName+" (cacheKey, cacheValue) VALUES (?, ?)";b.executeSql(c,[a,d],i,k)});var i=function(){h=!0,c(function(){j.removeItem(a)},j.options.maxAge),c(function(){e.resolve(h)})},k=function(a,b){var d="";switch(b.code){case b.SYNTAX_ERR:d="syntax error has occurred. "+b.message,console.warn(d);break;default:d="error caching data. error: "+b.message}console.warn(d),c(function(){e.reject(d)})};return e.promise},j.get=j.getItem=function(a){var d=b.defer(),e="";if(!j.db)return e="localWebSQL.db undefined",console.warn(e),c(function(){d.reject(e)}),d.promise;var f=j.db;f.transaction(function(b){var c="SELECT cacheValue FROM "+j.entityName+" WHERE cacheKey = ?";b.executeSql(c,[a],g,h)});var g=function(a,b){if(b){var e=null;b.rows&&b.rows.length&&(e=b.rows.item(0).cacheValue),c(function(){d.resolve(e)})}},h=function(a,b){var e="";switch(b.code){case b.SYNTAX_ERR:e="syntax error has occurred. "+b.message,console.warn(e);break;default:e="error retrieving data. error: "+b.message}console.warn(e),c(function(){d.reject(e)})};return d.promise},j.remove=j.removeItem=function(a){var d=b.defer(),e="";if(!j.db)return e="localWebSQL.db undefined",console.warn(e),c(function(){d.reject(e)}),c.flush(),d.promise;var f=j.db;f.transaction(function(b){var c="DELETE FROM "+j.entityName+" WHERE cacheKey = ?";b.executeSql(c,[a],g,h)});var g=function(){c(function(){d.resolve()})},h=function(a,b){var e="";switch(b.code){case b.SYNTAX_ERR:e="syntax error has occurred. "+b.message,console.warn(e);break;default:e="error removing data. error: "+b.message}console.warn(e),c(function(){d.reject(e)})};return d.promise},j.clear=function(){var a=b.defer(),d="";if(!j.db)return d="localWebSQL.db yet to be defined",console.warn(d),c(function(){a.reject(d)}),a.promise;var e=j.db,f=!1;e.transaction(function(a){var b="DELETE FROM "+j.entityName;a.executeSql(b,[],g,h)});var g=function(){console.log(j.entityName+" table in "+j.dbName+" webSQL data cleared"),f=!0,c(function(){a.resolve(f)})},h=function(b,d){var e="";switch(d.code){case d.SYNTAX_ERR:e="syntax error has occurred. "+d.message,console.warn(e);break;default:e="couldn't clear content of webSQL: "+j.entityName+". error: "+d.message}console.warn(e),c(function(){a.reject(e)})};return a.promise},j.length=function(){var a=b.defer(),d="";j.db||(d="localWebSQL.db undefined",console.warn(d),c(function(){a.reject(d)}));var e=j.db;e.transaction(function(a){var b="SELECT COUNT(*) AS Size from "+j.entityName;a.executeSql(b,[],f,g)});var f=function(b,d){d&&d.rows&&c(function(){a.resolve(d.rows.item(0).Size)})},g=function(b,d){var e="";switch(d.code){case d.SYNTAX_ERR:e="syntax error has occurred. "+d.message,console.warn(e);break;default:e="error computing current cache size. error: "+d.message}console.warn(e),c(function(){a.reject(e)})};return a.promise};var k=function(a){var b=(new Date).valueOf().toString(),c=a.save(b,b);return c.then(function(){a.remove(b)}),c},l=function(){try{k(g).then(function(a){return a?g:void k(h).then(function(a){return a?(console.log("attempting sessionStorage client caching"),h):(console.log("attempting POLY_FILL client caching"),d)})})}catch(a){return console.error(a.description),console.warn("....defaulting to POLY_FILL client caching"),d}}(),m={LOCAL_STORAGE:"localStorage",SESSION_STORAGE:"sessionStorage",INDEXED_DB:"indexedDB",WEB_SQL:"webSQL",POLY_FILL:"polyFill"},n={dbName:"cacheDB",entityName:"cacheTable",deletableCacheItems:10,maxAge:6e5,storage:m.POLY_FILL};return{POLY_FILL:d,localStorageDB:g,localSessionStorage:h,localIndexedDB:i,localWebSQL:j,cacheType:m,store:l,storeQuotaExceeded:e,storageExist:k,options:n,init:function(e){var f=b.defer();if(e&&e.hasOwnProperty("dbName")&&e.dbName&&(n.dbName=e.dbName),e&&e.hasOwnProperty("entityName")&&e.entityName&&(n.entityName=e.entityName),e&&e.hasOwnProperty("deletableCacheItems")&&e.deletableCacheItems&&(n.deletableCacheItems=e.deletableCacheItems),e&&e.hasOwnProperty("maxAge")&&e.maxAge&&(n.maxAge=e.maxAge),e&&e.hasOwnProperty("cacheType")&&e.cacheType){n.storage=e.cacheType;var k=function(a){c(function(){f.resolve(a)}),l=i,console.debug("cacheType overriden as indexedDB"),console.log(i.dbName+" indexedDB database opened")},m=function(a){c(function(){f.resolve(a)}),l=j,console.debug("cacheType overriden as webSQL"),console.log(j.dbName+" webSQL database opened")},o=function(a){c(function(){f.resolve(a)}),l=g,console.debug("cacheType overriden as localStorage"),console.log(g.dbName+" localStorage database opened")},p=function(a){c(function(){f.resolve(a)}),l=h,console.debug("cacheType overriden as sessionStorage"),console.log(h.dbName+" sessionStorage database opened")},q=function(){c(function(){f.resolve()}),l=d,console.debug("cacheType overriden as POLY_FILL"),console.log(d.dbName+" POLY_FILL database opened")};try{switch(n.storage){case"indexedDB":a.indexedDB=a.IndexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,a.indexedDB&&(i.options=n,i.open().then(function(a){a?k(a):(j.options=n,j.open().then(function(a){a?m(a):(g.options=n,g.open().then(function(a){a?o(a):(h.options=n,h.open().then(function(a){a?p(a):(d.options=n,q())}))}))}))}));break;case"webSQL":a.openDatabase&&(j.options=n,j.open().then(function(a){a?m(a):(i.options=n,i.open().then(function(a){a?k(a):(g.options=n,g.open().then(function(a){a?o(a):(h.options=n,h.open().then(function(a){a?p(a):(d.options=n,q())}))}))}))}));break;case"localStorage":a.localStorage&&(g.options=n,g.open().then(function(a){a&&g.db.save?o(a):(i.options=n,i.open().then(function(a){a?k(a):(j.options=n,j.open().then(function(a){a?m(a):(h.options=n,h.open().then(function(a){a?p(a):(d.options=n,q())}))}))}))}));break;case"sessionStorage":a.sessionStorage&&(h.options=n,h.open().then(function(a){a&&h.db.save?p(a):(i.options=n,i.open().then(function(a){a?k(a):(j.options=n,j.open().then(function(a){a?m(a):(g.options=n,g.open().then(function(a){a?o(a):(d.options=n,q())}))}))}))}));break;case"POLY_FILL":d.options=n,d.open().then(function(){q()})}return f.promise}catch(r){l=d,l.options=n,console.warn("chosen cacheType probably not supported...using POLY_FILL as fallback cacheType. error: "+r)}}},save:function(a,b){return l.save(a,b)},remove:function(a){return l.remove(a)},get:function(a){return l.get(a)},length:function(){return l.length()},clear:function(){return l.clear()}}}]);
//# sourceMappingURL=angular-cache-service.min.js.map